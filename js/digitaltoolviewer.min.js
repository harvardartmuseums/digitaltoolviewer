function random(s){s||(s=++randomSeed);var x=1e4*Math.sin(s);return x-Math.floor(x)}function lastSpaceIndex(text){var lastSpace=text.split("").reverse().join("").indexOf(" ");return-1==lastSpace&&(lastSpace=0),lastSpace}function wrapText(context,x,y,text,fontSize,font,up,width){if(up=void 0!=up&&up,width=void 0==width?1020:width,void 0==text)return y;var chars=Math.floor(width/fontSize*2);context.fillStyle="#000000",context.font=fontSize+"px "+font;var i=0,lastSpace=0;if(up){for(var lines=[];text.length>0;)lastSpace=text.length>chars?lastSpaceIndex(text.slice(0,chars)):0,lines.push(text.slice(0,chars-lastSpace)),text=text.slice(chars-lastSpace),i--;for(var j=0;j<lines.length;j++)context.fillText(lines[j],x,y-(lines.length-j)*(fontSize+10))}else for(;text.length>0;)lastSpace=text.length>chars?lastSpaceIndex(text.slice(0,chars)):0,context.fillText(text.slice(0,chars-lastSpace),x,y+i*(fontSize+10)),text=text.slice(chars-lastSpace),i++;return y+i*(fontSize+10)}function centerText(context,width,height,text,fontSize,font){var chars=Math.floor(width/fontSize*2);context.fillStyle="#000000",context.font=fontSize+"px "+font,context.textAlign="center";for(var i=0,lastSpace=0,lines=[];text.length>0;)lastSpace=text.length>chars?lastSpaceIndex(text.slice(0,chars)):0,lines.push(text.slice(0,chars-lastSpace)),text=text.slice(chars-lastSpace);if(lines.length>6)centerText(context,width,height,lines.join(""),fontSize-2,font);else for(i=0;i<lines.length;i++)context.fillText(lines[i],width/2,(height+fontSize*(2*i-lines.length+1.5))/2)}function randomSign(){return 1-2*Math.round(random())}function resize(){renderer.setSize(canvas.offsetWidth,canvas.offsetHeight),cssRenderer.setSize(cssCanvas.offsetWidth,cssCanvas.offsetHeight)}function setupResize(){window.addEventListener("resize",function(){resize(),animate()})}function setupRendering(){canvas=document.getElementById("canvas"),cssCanvas=document.getElementById("cssCanvas"),scene=new THREE.Scene,(camera=new THREE.PerspectiveCamera(75,16/9,wallDepth,1e4)).layers.enable(2),camera.mirrorsEnabled=!0,camera.position.z=0,camera.position.y=200,camera.rotateY(THREE.Math.degToRad(0)),camera.updateMatrix(),(interactionCamera=new THREE.PerspectiveCamera(75,16/9,wallDepth,wallUnitWidth)).layers.set(1),interactionCamera.position.z=0,interactionCamera.position.y=200,interactionCamera.rotateY(THREE.Math.degToRad(0)),interactionCamera.updateMatrix(),setupCSS(),setupWebGL()}function setupCSS(){cssOverlay=new THREE.Scene,(cssRenderer=new THREE.CSS3DRenderer).setSize(cssCanvas.offsetWidth,cssCanvas.offsetHeight),document.body.appendChild(cssRenderer.domElement),cssRenderer.domElement.classList.add("threeJS")}function setupWebGL(){(renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0})).setSize(canvas.offsetWidth,canvas.offsetHeight),cssRenderer.domElement.appendChild(renderer.domElement),renderer.domElement.classList.add("threeJS"),renderer.domElement.classList.add("clickThrough")}function animate(){renderer.render(scene,interactionCamera),cssRenderer.render(cssOverlay,camera)}function Floor(width,breadth){width=void 0==width?1:width,breadth=void 0==breadth?1:breadth,this.mesh=new THREE.Group;var geometry=new THREE.BoxBufferGeometry(wallUnitWidth*width,wallDepth,wallUnitWidth*breadth),box=new THREE.Mesh(geometry,floorMaterial);return this.mesh.add(box),this.mesh.position.set(0,-wallDepth/2,0),this.mesh.updateMatrix(),this.mesh}function Ceiling(width,breadth){width=void 0==width?1:width,breadth=void 0==breadth?1:breadth,this.mesh=new THREE.Group;var geometry=new THREE.BoxBufferGeometry(wallUnitWidth*width,wallDepth,wallUnitWidth*breadth),ceiling=new THREE.Mesh(geometry,ceilingMaterial);return this.mesh.add(ceiling),this.mesh.position.set(0,wallHeight+wallDepth/2,0),this.mesh.updateMatrix(),this.mesh}function Wall(door){this.mesh=new THREE.Group;var geometry,box;return door?(geometry=new THREE.BoxBufferGeometry((wallUnitWidth-doorWidth)/2,wallHeight,wallDepth),(box=new THREE.Mesh(geometry,wallMaterial)).position.set((wallUnitWidth-doorWidth)/2,wallHeight/2,0),box.updateMatrix(),this.mesh.add(box),obstacles.push(box),(box=new THREE.Mesh(geometry,wallMaterial)).position.set(-(wallUnitWidth-doorWidth)/2,wallHeight/2,0),box.updateMatrix(),this.mesh.add(box),obstacles.push(box),geometry=new THREE.BoxBufferGeometry(doorWidth,wallHeight-doorHeight,wallDepth),(box=new THREE.Mesh(geometry,wallMaterial)).position.set(0,(wallHeight+doorHeight)/2,0),box.updateMatrix(),this.mesh.add(box),geometry=new THREE.BoxBufferGeometry(wallUnitWidth,wallDepth,wallDepth),(box=new THREE.Mesh(geometry,floorMaterial)).position.set(0,-wallDepth/2,0),box.updateMatrix(),this.mesh.add(box)):(geometry=new THREE.BoxBufferGeometry(wallUnitWidth,wallHeight,wallDepth),(box=new THREE.Mesh(geometry,wallMaterial)).position.set(0,wallHeight/2,0),box.updateMatrix(),this.mesh.add(box),obstacles.push(box)),this.mesh}function TextPanel(title,image,caption,credit,description){this.mesh=new THREE.Group;var panel=document.createElement("canvas");panel.width="1024",panel.height="2048";var context=panel.getContext("2d");context.fillStyle="#FFFFFF",context.fillRect(0,0,1024,2048);var offsetTop=wrapText(context,10,70,title,60,font)+20;void 0!=description&&(offsetTop=wrapText(context,10,offsetTop,description,30,font)+20);var offsetBottom=wrapText(context,10,1365,credit,20,font,!0)-10;offsetBottom=wrapText(context,10,offsetBottom,caption,30,font,!0)-30;var pixelRatio=wallUnitWidth/4/1024,boxWidth=1004*pixelRatio,boxHeight=(offsetBottom-offsetTop-40)*pixelRatio;Image3D(this.mesh,image,new THREE.Vector3(0,wallUnitWidth/6-offsetTop*pixelRatio-boxHeight/2,wallDepth/2),boxWidth,boxHeight),geometry=new THREE.BoxBufferGeometry(wallUnitWidth/4,wallUnitWidth/2,wallDepth);var texture=new THREE.CanvasTexture(panel),material=new THREE.MeshLambertMaterial({map:texture}),label=new THREE.Mesh(geometry,material);return label.position.set(0,wallUnitWidth/6-wallUnitWidth/4,0),label.updateMatrix(),this.mesh.add(label),this.mesh.position.set(0,wallHeight/2,0),this.mesh.rotateY(THREE.Math.degToRad(180)),this.mesh.updateMatrix(),this.mesh}function TStand(title,image,caption,credit,description){this.mesh=new THREE.Group;var textPanel=new TextPanel(title,image,caption,credit,description);textPanel.scale.set(.3,.3,.3),textPanel.position.set(0,wallHeight/3,0),textPanel.updateMatrix(),this.mesh.add(textPanel),(textPanel=new TextPanel(title,image,caption,credit,description)).scale.set(.3,.3,.3),textPanel.rotateY(THREE.Math.degToRad(180)),textPanel.position.set(0,wallHeight/3,0),textPanel.updateMatrix(),this.mesh.add(textPanel);var geometry=new THREE.BoxBufferGeometry(.4*wallUnitWidth/4,wallHeight/3+.3*wallUnitWidth/6+.05*wallUnitWidth/4,.3*wallDepth-.01),stand=new THREE.Mesh(geometry,wallMaterial);return stand.position.set(0,(wallHeight/3+.3*wallUnitWidth/6+.05*wallUnitWidth/4)/2,0),stand.updateMatrix(),this.mesh.add(stand),obstacles.push(stand),geometry=new THREE.BoxBufferGeometry(.4*wallUnitWidth/4,wallDepth/10,.4*wallUnitWidth/3),(stand=new THREE.Mesh(geometry,wallMaterial)).position.set(0,wallDepth/20,0),stand.updateMatrix(),this.mesh.add(stand),this.mesh}function setupModules(){for(var l,i=0;i<gridLocations.length;i++)l=gridLocations[i],moduleLocations.push(new THREE.Vector3((l[0]-1.5)*(wallUnitWidth-3*wallDepth)/4,(l[1]-1.5)*(wallUnitWidth-3*wallDepth)/4,.01));socket.on("slideOverlay",function(id,clip){document.getElementById(id).style.clipPath="inset(0% "+clip+"% 0% 0%)"})}function cleanModules(modules,slide,fixedModules){if(0!=modules.length){var module=modules.shift();if(-1==validTypes.indexOf(module.type.toString()))loaded(),cleanModules(modules,slide,fixedModules);else if(1==module.type&&null!=textToRemove.exec(module.text))loaded(),cleanModules(modules,slide,fixedModules);else if(2==module.type){var img=new Image;img.onload=function(){409==img.width&&15==img.height?(loaded(),cleanModules(modules,slide,fixedModules)):(fixedModules.push(module),cleanModules(modules,slide,fixedModules)),img.remove()},img.src=module.images[0].file}else fixedModules.push(module),cleanModules(modules,slide,fixedModules)}else addModulesToSlide(fixedModules,slide)}function addModulesToSlide(modules,slide){var module;if(1==modules.length)(module=new Module(modules[0])).position.set(0,-1.5*(wallUnitWidth-3*wallDepth)/4,.01),module.updateMatrix(),slide.add(module);else if(2==modules.length)(module=new Module(modules[0])).position.set((wallUnitWidth-3*wallDepth)/8,-1.5*(wallUnitWidth-3*wallDepth)/4,.01),module.updateMatrix(),slide.add(module),(module=new Module(modules[1])).position.set(-(wallUnitWidth-3*wallDepth)/8,-1.5*(wallUnitWidth-3*wallDepth)/4,.01),module.updateMatrix(),slide.add(module);else for(var location,locations=moduleLocations.slice(0,2*Math.ceil(modules.length/2)),i=0;i<modules.length&&0!=locations.length;i++)module=new Module(modules[i]),location=Math.floor(locations.length*random()),module.position.copy(locations[location]),module.updateMatrix(),locations.splice(location,1),slide.add(module)}function Slide(slide){this.mesh=new THREE.Group;var panel=document.createElement("canvas");panel.classList.add("slideTitle"),panel.width="512",panel.height="512";var context=panel.getContext("2d");context.fillStyle="#FFFFFF",context.fillRect(0,0,512,512),centerText(context,512,512,slide.title,80,font),geometry=new THREE.BoxBufferGeometry((wallUnitWidth-3*wallDepth)/6,(wallUnitWidth-3*wallDepth)/6,.02);var texture=new THREE.CanvasTexture(panel),material=new THREE.MeshLambertMaterial({map:texture}),label=new THREE.Mesh(geometry,material);return label.position.set(0,-(wallUnitWidth-3*wallDepth)/8,0),label.updateMatrix(),this.mesh.add(label),load(slide.modules.length),cleanModules(slide.modules,this.mesh,[]),this.mesh}function Stop(stop){if(this.mesh=new THREE.Group,void 0==stop)this.mesh.add(new Wall);else{this.mesh.add(new Wall(!0));var textPanel=new TextPanel(stop.title,stop.image_file,stop.image_caption,stop.image_credit);textPanel.position.set(-wallUnitWidth/3,wallHeight/2-wallUnitWidth/12,-.01),textPanel.updateMatrix(),this.mesh.add(textPanel);for(var wall,extraWalls=stop.slides.length<=3?0:Math.ceil((stop.slides.length-3)/2),i=0;i<=extraWalls;i++)(wall=new Wall).position.set(wallUnitWidth/2-wallDepth/2,0,wallUnitWidth*(i+.5)),wall.rotateY(THREE.Math.degToRad(90)),wall.updateMatrix(),this.mesh.add(wall),(wall=new Wall).position.set(-wallUnitWidth/2+wallDepth/2,0,wallUnitWidth*(i+.5)),wall.rotateY(THREE.Math.degToRad(90)),wall.updateMatrix(),this.mesh.add(wall);if((wall=new Wall).position.set(0,0,wallUnitWidth*(extraWalls+1)+wallDepth/2),wall.updateMatrix(),this.mesh.add(wall),1==stop.slides.length)(slide=new Slide(stop.slides[0])).position.set(0,wallHeight/2,wallUnitWidth),slide.rotateY(THREE.Math.degToRad(180)),slide.updateMatrix(),this.mesh.add(slide);else{Math.floor((2*extraWalls+3-stop.slides.length)/2);for(var slide,slideIndex=0,i=0;i<extraWalls+1;i++)(slide=new Slide(stop.slides[slideIndex])).position.set(wallUnitWidth/2-wallDepth,wallHeight/2,wallUnitWidth*(i+.5)),slide.rotateY(THREE.Math.degToRad(-90)),slide.updateMatrix(),this.mesh.add(slide),slideIndex++;(slide=new Slide(stop.slides[slideIndex])).position.set(0,wallHeight/2,wallUnitWidth*(extraWalls+1)),slide.rotateY(THREE.Math.degToRad(180)),slide.updateMatrix(),this.mesh.add(slide),slideIndex++;for(i=extraWalls+1;i>0&&slideIndex!=stop.slides.length;i--)(slide=new Slide(stop.slides[slideIndex])).position.set(-wallUnitWidth/2+wallDepth,wallHeight/2,wallUnitWidth*(i-.5)),slide.rotateY(THREE.Math.degToRad(90)),slide.updateMatrix(),this.mesh.add(slide),slideIndex++}var floor=new Floor(1,extraWalls+1);floor.position.set(0,-wallDepth/2,(wallUnitWidth*(extraWalls+1)+wallDepth)/2),floor.updateMatrix(),this.mesh.add(floor);var ceiling=new Ceiling(1,extraWalls+1);ceiling.position.set(0,wallHeight+wallDepth/2,(wallUnitWidth*(extraWalls+1)+wallDepth)/2),ceiling.updateMatrix(),this.mesh.add(ceiling)}return this.mesh}function getTourFromURL(){var tourNumber,match=new RegExp("\\?tour=([0-9]*)(?:&screen=([0-8]?))?(?:&id=([0-9]{4}?))?").exec(window.location.search);if(null!=match){if(tourNumber=match[1],match[2]){thisScreen=match[2];var offsetHorizontal=match[2]%3,offsetVertical=Math.floor(match[2]/3);camera.setViewOffset(5760,3240,1920*offsetHorizontal,1080*offsetVertical,1920,1080),cssCanvas.style.width="300vw",cssCanvas.style.height="300vh",cssRenderer.domElement.style.top=-100*offsetVertical+"vh",cssRenderer.domElement.style.left=-100*offsetHorizontal+"vw",renderer.domElement.style.top=100*offsetVertical+"vh",renderer.domElement.style.left=100*offsetHorizontal+"vw",resize()}return seed=match[3],socket.emit("id",match[3]),socket.emit("getTour",tourNumber),!0}return!1}function buildTour(){if(socket.on("tourData",function(data){tour=data,THREE.Object3D.DefaultMatrixAutoUpdate=!1,building=new TourRoom(tour),scene.add(building),finishSetup()}),!getTourFromURL()){var element=document.createElement("div");document.body.appendChild(element),element.id="tourPrompt",element.innerHTML='<span>Tour number:<br /><form action="" method="get"><input type="number" min="0" size="4" name="tour" id="tourNumber" /><br /><br />Lightbox screen:<br /><input type="number" min="0" max="8" size="1" name="screen" id="screenNumber" /><br /><br />Syncing ID:<br /><input type="number" min="1000" max="9999" size="4" name="id" /><br /><br /><input type="submit" /></form></span>'}}function TourRoom(tourData){this.mesh=new THREE.Group;var wall,walls=0==tourData.stops.length?4:4*Math.ceil(tourData.stops.length/4),offsetCenter=(wallUnitWidth*walls/4+wallDepth)/2,offsetWall=walls/4/2-.5;this.mesh.add(new Floor(walls/4,walls/4)),this.mesh.add(new Ceiling(walls/4,walls/4));var tstand=new TStand(tourData.title,tourData.image_file,tourData.image_caption,tourData.image_credit,tourData.description);tstand.position.set(0,0,3.01*-wallDepth),tstand.updateMatrix(),this.mesh.add(tstand);var light=new THREE.DirectionalLight(16777215,.5);light.position.set(-2e3,0,1750),scene.add(light),light.updateMatrix(),light.layers.enable(1),lights.push(light),(light=new THREE.DirectionalLight(16777215,.6)).position.set(1e3,-500,-1e3),scene.add(light),light.updateMatrix(),light.layers.enable(1),lights.push(light),(light=new THREE.DirectionalLight(16777215,.3)).position.set(500,2e3,250),scene.add(light),light.updateMatrix(),light.layers.enable(1),lights.push(light);for(var i=0;i<walls;i++){switch(wall=new Stop(tourData.stops[i]),i%4){case 0:wall.position.set((i/4-offsetWall)*wallUnitWidth,0,-offsetCenter),wall.rotateY(THREE.Math.degToRad(180));break;case 1:wall.position.set(((i-1)/4-offsetWall)*wallUnitWidth,0,offsetCenter);break;case 2:wall.position.set(offsetCenter,0,(offsetWall-(i-2)/4)*wallUnitWidth),wall.rotateY(THREE.Math.degToRad(90));break;case 3:wall.position.set(-offsetCenter,0,((i-3)/4-offsetWall)*wallUnitWidth),wall.rotateY(THREE.Math.degToRad(-90))}wall.updateMatrix(),this.mesh.add(wall)}return this.mesh}function ModuleLabel(width,title,caption,credit){var panel=document.createElement("canvas");panel.width="1024",panel.height="512";var context=panel.getContext("2d");context.fillStyle="#FFFFFF",context.fillRect(0,0,1024,512),wrapText(context,50,wrapText(context,50,70,title,55,font,!1,924)+20,caption,35,font,!1,924),wrapText(context,50,512,credit,25,font,!0,924);var geometry=new THREE.BoxBufferGeometry(width,width/2,.02),texture=new THREE.CanvasTexture(panel),material=new THREE.MeshLambertMaterial({map:texture}),label=new THREE.Mesh(geometry,material);return this.mesh=label,this.mesh}function Module(module){this.mesh=new THREE.Group;var type=moduleTypes[module.type],offset=(wallUnitWidth-3*wallDepth)/8-wallDepth/10,top=right=offset,bottom=left=-offset;if(type.label){var label,labelWidth=2*offset/3;label="images"==type.media?new ModuleLabel(labelWidth,module.images[0].title,module.images[0].caption,module.images[0].credit):new ModuleLabel(labelWidth,module[type.media].title,module[type.media].caption,module[type.media].credit);var verticalAlign=randomSign();7!=module.type&&8!=module.type||(module.images[0].title,module.images[0].caption,module.images[0].credit,module.images[1].title,module.images[1].caption,!module.images[1].credit)?(label.position.set(randomSign()*(offset-labelWidth/2),verticalAlign*(offset-labelWidth/2),0),label.updateMatrix()):(label.position.set(-(offset-labelWidth/2),verticalAlign*(offset-labelWidth/2),0),label.updateMatrix(),this.mesh.add(label),(label=new ModuleLabel(labelWidth,module.images[1].title,module.images[1].caption,module.images[1].credit)).position.set(offset-labelWidth/2,verticalAlign*(offset-labelWidth/2),0),label.updateMatrix()),top-=labelWidth*(verticalAlign+1)/2,bottom-=labelWidth*(verticalAlign-1)/2,this.mesh.add(label)}var width=right-left,height=top-bottom;if(void 0!=type.frame)moduleObj=new type.frame(width,height,type.cons,module);else var moduleObj=new type.cons(width,height,module);return moduleObj.position.set(left+width/2,bottom+height/2,0),moduleObj.updateMatrix(),this.mesh.add(moduleObj),this.mesh}function Screen(width,height,constructor,module){this.mesh=new THREE.Group;var geometry=new THREE.BoxBufferGeometry(width-wallDepth/4,height-wallDepth/4,wallDepth/8),screen=new THREE.Mesh(geometry,screenMaterial);screen.position.set(0,0,1.5*wallDepth/8),screen.layers.enable(1),screen.updateMatrix(),this.mesh.add(screen);var frame=new Frame(width,height,wallDepth/8,wallDepth/80,monitorMaterial);frame.position.set(0,0,wallDepth/8),frame.updateMatrix(),this.mesh.add(frame),geometry=new THREE.BoxBufferGeometry(width-3*wallDepth/5,height-3*wallDepth/5,1.5*wallDepth/8);var mount=new THREE.Mesh(geometry,monitorMaterial);mount.position.set(0,0,.75*wallDepth/8),mount.updateMatrix(),this.mesh.add(mount);var obj=constructor(width-wallDepth/5,height-wallDepth/5,module);return obj.position.set(0,0,2*wallDepth/8),obj.updateMatrix(),this.mesh.add(obj),this.mesh}function GlazedFrame(width,height,constructor,module){this.mesh=new THREE.Group;var obj=constructor(width-wallDepth/5,height-wallDepth/5,module);this.mesh.add(obj);var frame=new Frame(width,height,wallDepth/12,wallDepth/40,frameMaterial);return frame.position.set(0,0,0),frame.updateMatrix(),this.mesh.add(frame),this.mesh}function Frame(width,height,frameWidth,frameProtrusion,material){this.mesh=new THREE.Group;var geometry=new THREE.BoxBufferGeometry(width-frameWidth,frameWidth,frameWidth+frameProtrusion),frame=new THREE.Mesh(geometry,material);return frame.position.set(0,height/2-frameWidth,frameProtrusion+frameWidth/2),frame.updateMatrix(),frame.layers.enable(1),this.mesh.add(frame),(frame=new THREE.Mesh(geometry,material)).position.set(0,-height/2+frameWidth,frameProtrusion+frameWidth/2),frame.updateMatrix(),frame.layers.enable(1),this.mesh.add(frame),geometry=new THREE.BoxBufferGeometry(frameWidth,height-frameWidth,frameWidth+frameProtrusion),(frame=new THREE.Mesh(geometry,material)).position.set(width/2-frameWidth,0,frameProtrusion+frameWidth/2),frame.updateMatrix(),frame.layers.enable(1),this.mesh.add(frame),(frame=new THREE.Mesh(geometry,material)).position.set(-width/2+frameWidth,0,frameProtrusion+frameWidth/2),frame.updateMatrix(),frame.layers.enable(1),this.mesh.add(frame),this.mesh}function generateCutout(mesh,cssElement,pos,width,height,scale,interactive,highres,interact){pos=void 0==pos?new THREE.Vector3(0,0,0):pos,width=void 0==width?cssElement.offsetWidth:width,height=void 0==height?cssElement.offsetHeight:height,scale=void 0==scale?new THREE.Vector3(1,1,1):scale,pos.z+=.05;var cssObject=new THREE.CSS3DObject(cssElement);cssOverlay.add(cssObject),highres&&(width=Math.floor(width/4),height=Math.floor(height/4));var geometry=new THREE.PlaneBufferGeometry(width-3,height-3),cutoutPlane=new THREE.Mesh(geometry,cutoutMaterial);if(cutoutPlane.position.set(pos.x,pos.y,pos.z),cutoutPlane.scale.set(scale.x,scale.y,1),cutoutPlane.updateMatrix(),cutoutPlane.layers.set(2),mesh.add(cutoutPlane),interactive){var interactionPlane=cutoutPlane.clone();interactionPlane.material=brightMaterial,interactionPlane.position.set(pos.x,pos.y,pos.z),interactionPlane.updateMatrix(),interactionPlane.layers.set(1),mesh.add(interactionPlane),interactiveObjects.push(interactionPlane),interactionMethod.push(interact)}mesh.updateMatrixWorld(),cutoutPlane.updateMatrixWorld();var p=new THREE.Vector3,r=new THREE.Quaternion,s=new THREE.Vector3;cutoutPlane.matrixWorld.decompose(p,r,s),cssObject.position.set(p.x,p.y,p.z),cssObject.setRotationFromQuaternion(r),cssObject.scale.set(s.x,s.y,s.z),highres&&cssObject.scale.multiplyScalar(.25),cssObject.updateMatrix(),animate(),interactive&&loaded()}function openImage(){socket.emit("open",'<img src="'+this+'" />')}function Image3D(mesh,image,pos,boxWidth,boxHeight,interactive){pos=void 0==pos?new THREE.Vector3(0,0,0):pos;var imageElement=document.createElement("img");imageElement.onload=function(){var scale=new THREE.Vector3(1,1,1);imageElement.width/imageElement.height>boxWidth/boxHeight?scale.setScalar(4*boxWidth/imageElement.width):(scale.setScalar(4*boxHeight/imageElement.height),interactive||(pos.x+=-(boxWidth-imageElement.width*boxHeight/imageElement.height)/2)),setTimeout(function(){generateCutout(mesh,imageElement,pos,imageElement.width,imageElement.height,scale,interactive,!0,openImage.bind(image))},100)},imageElement.src=image;var imageObject=new THREE.CSS3DObject(imageElement);cssOverlay.add(imageObject)}function toggleAudio(){this.paused||this.ended?this.play():(this.pause(),this.currentTime=0)}function AudioModule(width,height,module){this.mesh=new THREE.Group;var label=new ModuleLabel(width/3,module.audio.title,void 0,module.audio.credit);label.position.set(0,-height/6-.1*height/2-width/6,0),label.updateMatrix(),this.mesh.add(label);var audioElement=document.createElement("audio");audioElement.src=module.audio.url,audioElement.preload="auto";var toggleThisAudio=toggleAudio.bind(audioElement),geometry=new THREE.BoxBufferGeometry(width/3,.1*height/2,width/6),shelf=new THREE.Mesh(geometry,wallMaterial);shelf.position.set(0,-height/6-.1*height/4,width/12),shelf.updateMatrix(),shelf.layers.enable(1),this.mesh.add(shelf),interactiveObjects.push(shelf),interactionMethod.push(toggleThisAudio),geometry=new THREE.BoxBufferGeometry(width/5,3*height/12,width/10);var speaker=new THREE.Mesh(geometry,speakerMaterial);speaker.position.set(0,-height/24,width/12),speaker.updateMatrix(),speaker.layers.enable(1),this.mesh.add(speaker),interactiveObjects.push(speaker),interactionMethod.push(toggleThisAudio),geometry=new THREE.CylinderBufferGeometry(width/10,width/10,width/10,20),(speaker=new THREE.Mesh(geometry,speakerMaterial)).rotateX(THREE.Math.degToRad(90)),speaker.position.set(0,height/12,width/12),speaker.updateMatrix(),speaker.layers.enable(1),this.mesh.add(speaker),interactiveObjects.push(speaker),interactionMethod.push(toggleThisAudio),geometry=new THREE.SphereBufferGeometry(.75*width/10,20,20),(speaker=new THREE.Mesh(geometry,speakerGrillMaterial)).scale.set(1,1,.25),speaker.position.set(0,height/12,width/12+width/20),speaker.updateMatrix(),speaker.layers.enable(1),this.mesh.add(speaker),interactiveObjects.push(speaker),interactionMethod.push(toggleThisAudio);var playButtonMaterial=new THREE.MeshBasicMaterial({color:0});return geometry=new THREE.SphereBufferGeometry(width/100),(speaker=new THREE.Mesh(geometry,playButtonMaterial)).position.set(0,-width/10,width/12+width/20),speaker.updateMatrix(),speaker.layers.enable(1),this.mesh.add(speaker),interactiveObjects.push(speaker),interactionMethod.push(toggleThisAudio),audioElement.addEventListener("playing",function(){playButtonMaterial.color.set(16711680)}),audioElement.addEventListener("pause",function(){playButtonMaterial.color.set(0)}),audioElement.addEventListener("ended",function(){playButtonMaterial.color.set(0)}),loaded(),this.mesh}function toggleCloseup(){"running"==this.style.animationPlayState?this.style.animationPlayState="paused":this.style.animationPlayState="running"}function closeup(left,top,label){var div=document.createElement("div");div.className="closeup",div.style.top=top+"%",div.style.left=left+"%";var text=document.createElement("span");return text.innerHTML=label,div.appendChild(text),div}function CloseupModule(width,height,module){this.mesh=new THREE.Group;var element=document.createElement("div");element.classList.add("closeupModule"),element.style.width=4*width+"px",element.style.height=4*height+"px";var zoom=document.createElement("div");element.appendChild(zoom),zoom.className="zoom";var img=document.createElement("img"),scaleX=1,scaleY=1;return img.onload=function(){img.naturalWidth/img.naturalHeight<width/height?(scaleX=height/width*(img.naturalHeight/img.naturalWidth),zoom.style.margin="0 "+(1e3-1e3*scaleX)/2+"%",zoom.style.width=1e3*scaleX+"%"):(scaleY=width/height*(img.naturalWidth/img.naturalHeight),zoom.style.margin=(1e3-1e3*scaleY)/2+"% 0",zoom.style.height=1e3*scaleY+"%");for(var index=styleSheet.length,keyframes="@keyframes z"+module.id+" {",i=0;i<module.images[0].hotspots.length;i++)keyframes+=100*i/module.images[0].hotspots.length+"%, ",0==i&&(keyframes+="100%, "),keyframes+=100*(i+.4)/module.images[0].hotspots.length+"% ",keyframes+="{left: "+(-10*module.images[0].hotspots[i].coord_x*scaleX-1e3*(1-scaleX)/2)+"%; top: "+(-10*module.images[0].hotspots[i].coord_y*scaleY-1e3*(1-scaleY)/2)+"%; transform: scale(1, 1)} ",keyframes+=100*(i+.5)/module.images[0].hotspots.length+"%, ",keyframes+=100*(i+.9)/module.images[0].hotspots.length+"% ",keyframes+="{left: -450%; top: -450%; transform: scale(.1, .1)} ",zoom.appendChild(closeup(module.images[0].hotspots[i].coord_x,module.images[0].hotspots[i].coord_y,module.images[0].hotspots[i].caption));styleSheet.insertRule(keyframes,index),zoom.style.animation="z"+module.id+" "+10*module.images[0].hotspots.length+"s infinite",zoom.style.animationDelay=-10*random(module.id)+"s"},img.src=module.images[0].file,zoom.appendChild(img),setTimeout(function(){generateCutout(this,element,void 0,4*width,4*height,void 0,!0,!0,toggleCloseup.bind(zoom))}.bind(this.mesh),100),this.mesh}function ComparisonModule(width,height,module){return load(),this.mesh=new THREE.Group,Image3D(this.mesh,module.images[0].file,new THREE.Vector3(-width/4,0,0),width/2,height,!0),Image3D(this.mesh,module.images[1].file,new THREE.Vector3(width/4,0,0),width/2,height,!0),this.mesh}function openEmbed(){socket.emit("open",this)}function EmbedModule(width,height,module){this.mesh=new THREE.Group;var embedElement=document.createElement("div");return document.body.appendChild(embedElement),embedElement.classList.add("embedModule"),embedElement.style.width=4*width+"px",embedElement.style.height=4*height+"px",1==module.embed.embed_type?embedElement.innerHTML='<iframe src="'+module.embed.embed_code+'" frameborder="0" style="border:0" width="'+4*width+'px" height="'+4*height+'px" allowfullscreen></iframe>':2==module.embed.embed_type&&(embedElement.innerHTML=module.embed.embed_code),setTimeout(function(){generateCutout(this,embedElement,void 0,void 0,void 0,void 0,!0,!0,openEmbed.bind(embedElement.innerHTML))}.bind(this.mesh),100),this.mesh}function ImageModule(width,height,module){return this.mesh=new THREE.Group,Image3D(this.mesh,module.images[0].file,void 0,width,height,!0),this.mesh}function openMirador(){socket.emit("open",this,!0)}function MiradorModule(width,height,module){this.mesh=new THREE.Group;var miradorElement=document.createElement("div");return document.body.appendChild(miradorElement),miradorElement.classList.add("miradorModule"),miradorElement.style.width=4*width+"px",miradorElement.style.height=4*height+"px",miradorElement.innerHTML='<iframe src="http://www.harvardartmuseums.org/miradorviewer/module/'+module.mirador.id+'" frameborder="0" style="border:0" width="'+4*width+'px" height="'+4*height+'px" allowfullscreen></iframe>',setTimeout(function(){generateCutout(this,miradorElement,void 0,void 0,void 0,void 0,!0,!0,openMirador.bind(miradorElement.innerHTML))}.bind(this.mesh),100),this.mesh}function openOverlay(){socket.emit("openOverlay",this)}function OverlayModule(width,height,module){this.mesh=new THREE.Group;var element=document.createElement("div");return element.innerHTML='<img src="'+module.images[1].file+'" id="'+module.id+'_1" /><img src="'+module.images[0].file+'" id="'+module.id+'_0" />',document.body.appendChild(element),document.getElementById(module.id+"_0").style.clipPath="inset(0% 50% 0% 0%)",element.classList.add("overlayModule"),element.style.width=4*width+"px",element.style.height=4*height+"px",setTimeout(function(){generateCutout(this,element,void 0,4*width,4*height,void 0,!0,!0,openOverlay.bind(module.id+"_0"))}.bind(this.mesh),100),this.mesh}function setupAnimations(){styleSheet=document.createElement("style"),document.head.appendChild(styleSheet),styleSheet=styleSheet.sheet}function toggleSlideshow(){"running"==this.style.animationPlayState?this.style.animationPlayState="paused":this.style.animationPlayState="running"}function labeledImage(width,height,image,label){var div=document.createElement("div");div.className="labeledDiv",div.style.width=width,div.style.height=height;var img=document.createElement("img");img.src=image,div.appendChild(img);var text=document.createElement("span");return text.innerHTML=label,div.appendChild(text),div}function SlideshowModule(width,height,module){if(this.mesh=new THREE.Group,1==module.view_type){var element=document.createElement("div");element.classList.add("slideshowModule"),element.classList.add("slides"),element.style.width=4*width+"px",element.style.height=4*height+"px";var container=document.createElement("div");element.appendChild(container),container.style.width=100*(module.images.length+1)+"%";for(var index=styleSheet.length,keyframes="@keyframes s"+module.id+" {",i=0;i<module.images.length;i++)keyframes+=100*i/module.images.length+"%, ",keyframes+=100*(i+.9)/module.images.length+"% ",keyframes+="{left: "+100*-i+"%} ";keyframes+="100% {left: -"+100*module.images.length+"%}}",styleSheet.insertRule(keyframes,index),container.style.animation="s"+module.id+" "+15*module.images.length+"s infinite",container.style.animationDelay=-15*random(module.id)+"s";for(var text,i=0;i<module.images.length;i++)text="<h1>"+module.images[i].title+"</h1>"+(""!=module.images[i].caption?"<br /><h2>"+module.images[i].caption+"</h2>":"")+(""!=module.images[i].credit?"<br /><br />"+module.images[i].credit:""),container.appendChild(labeledImage(100/(module.images.length+1)+"%","100%",module.images[i].file,text));text="<h1>"+module.images[0].title+"</h1>"+(""!=module.images[0].caption?"<br /><h2>"+module.images[0].caption+"</h2>":"")+(""!=module.images[0].credit?"<br /><br />"+module.images[0].credit:""),container.appendChild(labeledImage(100/(module.images.length+1)+"%","100%",module.images[0].file,text)),setTimeout(function(){generateCutout(this,element,void 0,4*width,4*height,void 0,!0,!0,toggleSlideshow.bind(container))}.bind(this.mesh),100)}else{load(module.images.length-1);for(var max=Math.ceil(Math.sqrt(module.images.length)),i=0,j=0;j<max;j++)for(var k=0;k<max;k++){if(!(i<module.images.length))return this.mesh;Image3D(this.mesh,module.images[i].file,new THREE.Vector3((-max/2+.5+k)*width/max,(max/2-.5-j)*height/max,0),width/max,height/max,!0),i++}}return this.mesh}function openText(){socket.emit("open",this)}function TextModule(width,height,module){this.mesh=new THREE.Group;var element=document.createElement("div");return document.body.appendChild(element),element.innerHTML=module.text,element.classList.add("textModule"),element.style.width=4*(2*width/3+6)+"px",element.style.maxHeight=4*(height+6)+"px",setTimeout(function(){generateCutout(this,element,void 0,void 0,void 0,void 0,!0,!0,openText.bind(module.text))}.bind(this.mesh),100),this.mesh}function toggleVideo(video,vimeo){video&&(vimeo?video.getPaused().then(function(paused){paused?video.play():(video.pause(),video.setCurrentTime(0))}).catch(function(){video.play()}):1!=video.getPlayerState()?video.playVideo():(video.pauseVideo(),video.seekTo(0,!0)))}function VideoModule(width,height,module){var mesh=new THREE.Group,videoElement=document.createElement("div");document.body.appendChild(videoElement),videoElement.classList.add("videoModule"),videoElement.style.width=4*width+"px",videoElement.style.height=4*height+"px";var element=document.createElement("div");videoElement.appendChild(element);var video,vimeo=vimeoURL.exec(module.videos.url),youTube=youTubeURL.exec(module.videos.url);return null!=vimeo?(videoElement.innerHTML='<iframe src="https://player.vimeo.com/video/'+vimeo[1]+'?color=ffffff&title=0&byline=0&portrait=0" width="'+4*width+'" height="'+4*height+'" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>',videoElement.getElementsByTagName("iframe")[0].onload=function(){setTimeout(function(){generateCutout(mesh,videoElement,void 0,void 0,void 0,void 0,!0,!0,toggleVideo.bind(void 0,video,vimeo))},100)},(video=new Vimeo.Player(videoElement.getElementsByTagName("iframe")[0])).enableTextTrack("en")):null!=youTube?(videoElement.innerHTML='<iframe width="'+4*width+'" height="'+4*height+'" src="https://www.youtube.com/embed/'+youTube[1]+'?rel=0&amp;controls=0&amp;showinfo=0&amp;enablejsapi=1&amp;cc_load_policy=1&amp;disablekb=1&amp;fs=1&amp;modestbranding=1" frameborder="0" allowfullscreen></iframe>',videoElement.getElementsByTagName("iframe")[0].onload=function(){setTimeout(function(){generateCutout(mesh,videoElement,void 0,void 0,void 0,void 0,!0,!0,toggleVideo.bind(void 0,video,vimeo))},100)},video=new YT.Player(videoElement.getElementsByTagName("iframe")[0],{})):(videoElement.innerHTML=blueScreen,setTimeout(function(){generateCutout(mesh,videoElement,void 0,void 0,void 0,void 0,!0,!0,toggleVideo)},100)),mesh}function setupMove(){socket.on("move",move),socket.on("stop",stop),socket.on("jumpTo",function(location,rotation){camera.position.x=location.x,camera.position.y=location.y,camera.position.z=location.z,camera.rotation.y=rotation})}function move(direction){animationID?(prev=now,now=new Date,distanceTraveled=(now.valueOf()-prev.valueOf())*velocity):(now=new Date,distanceTraveled=5),animate(),animationID=requestAnimationFrame(move),resetRounds=0,-1!=directionList.indexOf(direction)&&(directions[direction]=!0),directions.left&&camera.rotateY(THREE.Math.degToRad(distanceTraveled/10)),directions.right&&camera.rotateY(THREE.Math.degToRad(-distanceTraveled/10)),directions.up&&camera.position.add(camera.getWorldDirection().multiplyScalar(distanceTraveled)),directions.down&&camera.position.add(camera.getWorldDirection().multiplyScalar(-distanceTraveled))}function stop(direction){directions[direction]&&(directions[direction]=!1),direction&&0!=directions.length||(cancelAnimationFrame(animationID),animationID=void 0)}function setupReset(){resetTimer=setInterval(reset,6e4),socket.on("reset",function(){reset(!0)})}function reset(s){s?(camera.position.z=0,camera.position.x=0,camera.position.y=200,camera.lookAt(new THREE.Vector3(0,200,-1)),stop(),animate()):resetRounds<5?resetRounds++:(resetRounds=0,socket.emit("reset"))}function setupInteraction(){interactRay=new THREE.Raycaster(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0),wallDepth,wallUnitWidth),mouse=new THREE.Vector2,socket.on("click",handleInteraction)}function handleInteraction(e){mouse.x=e.x,mouse.y=e.y,interactionCamera.position.copy(camera.position),interactionCamera.rotation.copy(camera.rotation),interactionCamera.updateMatrix(),interactRay.setFromCamera(mouse,interactionCamera);var intersections=interactRay.intersectObjects(interactiveObjects,!0),index=interactiveObjects.indexOf(intersections[0].object);-1!=index&&interactionMethod[index]()}function load(n){n?loading.toLoad+=n:loading.toLoad++}function loaded(){if(loading.loaded++,loading.toLoad<=loading.loaded){for(var interactionScene={obstacles:[],interactiveObjects:[],lights:[]},i=0;i<interactiveObjects.length;i++)interactiveObjects[i].parent.updateMatrixWorld(),THREE.SceneUtils.detach(interactiveObjects[i],interactiveObjects[i].parent,scene),interactionScene.interactiveObjects.push(interactiveObjects[i].toJSON());for(i=0;i<obstacles.length;i++)obstacles[i].parent.updateMatrixWorld(),THREE.SceneUtils.detach(obstacles[i],obstacles[i].parent,scene),interactionScene.obstacles.push(obstacles[i].toJSON());for(i=0;i<lights.length;i++)lights[i].parent.updateMatrixWorld(),THREE.SceneUtils.detach(lights[i],lights[i].parent,scene),interactionScene.lights.push(lights[i].toJSON());socket.emit("scene",{scene:interactionScene,wallDepth:wallDepth,wallUnitWidth:wallUnitWidth}),interactionScene=null}}function setup(){setupAnimations(),setupModules(),setupRendering(),buildTour()}function finishSetup(){setupResize(),setupMove(),setupReset(),setupInteraction(),animate()}var randomSeed=1,canvas,cssCanvas,scene,camera,interactionCamera,renderer,cssOverlay,cssRenderer,interactiveObjects=[],interactionMethod=[],mirrors=[],mirrorFrameCount=0,lastUpdated,ended=!0,doorWidth=200,wallUnitWidth=600,doorHeight=350,wallHeight=600,wallDepth=25,lights=[],wallMaterial=floorMaterial=ceilingMaterial=new THREE.MeshLambertMaterial,screenMaterial=new THREE.MeshPhongMaterial({color:0}),monitorMaterial=new THREE.MeshPhongMaterial({color:5592405}),speakerMaterial=frameMaterial=new THREE.MeshLambertMaterial({color:14540253}),speakerGrillMaterial=new THREE.MeshLambertMaterial({color:2236962}),textMaterial=new THREE.MeshLambertMaterial({color:0}),cutoutMaterial=new THREE.MeshBasicMaterial({color:0,opacity:0}),brightMaterial=new THREE.MeshBasicMaterial({color:16777215}),textToRemove=/^(<[^>]*>&nbsp;<\/[^>]*>\n)?(<[^>]*>)+(?:Fig(?:ure)?\.? [0-9]*|Locate on the Floor Plan|Click here for.*)(<\/[^>]*>)+$/,moduleLocations=[],gridLocations=[[1,0],[2,0],[0,1],[3,1],[0,0],[3,0],[1,2],[2,2],[0,2],[3,2],[1,3],[2,3],[0,3],[3,3]],tour,building,thisScreen,moduleTypes={1:{label:!1,cons:TextModule},2:{label:!0,media:"images",cons:ImageModule,frame:GlazedFrame},3:{label:!1,cons:SlideshowModule,frame:Screen},4:{label:!0,media:"videos",cons:VideoModule,frame:Screen},5:{label:!1,cons:AudioModule},6:{label:!0,media:"images",cons:CloseupModule,frame:Screen},7:{label:!0,media:"images",cons:OverlayModule,frame:Screen},8:{label:!0,media:"images",cons:ComparisonModule,frame:Screen},11:{label:!1,cons:EmbedModule,frame:Screen},12:{label:!1,cons:MiradorModule,frame:Screen}},validTypes=Object.keys(moduleTypes),styleSheet,vimeoURL=new RegExp("(?:vimeo.com/|vimeo.com/video/)([0-9]+)","i"),youTubeURL=new RegExp("(?:youtube.com/watch\\?v=|youtu.be/|youtube.com/embed/)([0-9a-zA-Z]+)","i"),blueScreen='<div class="error">A problem has been detected and Windows has been shut down to prevent damage to your computer.<br /><br />If this is the first time you\'ve seen this Stop error screen, restart your computer. If this screen appears again, follow these steps:<br /><br />Check to make sure any new hardware or software is properly installed. If this is a new installation, ask your hardware or software manufacturer for any Windows updates you might need.<br /><br />If problems continue, disable or remove any newly installed hardware or software. Disable BIOS memory options such as caching or shadowing. If you need to use Safe Mode to remove or disable components, restart your computer, press F8 to select Advanced Startup Options, and then select Safe Mode.<br /><br />Technical information:<br /><br />*** STOP: 0x00000050 (0xFD3094C2, 0x00000001, 0xFBFE7617, 0x00000000)<br /><br /><br />Collecting data for crash dump ...<br />Initializing disk for crash dump ...<br />Beginning dump of physical memory.<br />Dumping physical memory to disk: 100<br />Physical memory dump complete.</div>',animationID,directions={left:!1,up:!1,right:!1,down:!1},directionList=Object.keys(directions),now,prev,velocity=.05,distanceTraveled=0,obstacles=[],resetTimer,resetRounds=0,interactRay,mouse,socket=io("/screens-namespace");socket.on("id",function(id){alert("Enter the following id to sync controls or other screens with this screen: "+id)});var font="Helvetica",loading={toLoad:0,loaded:0};setup();